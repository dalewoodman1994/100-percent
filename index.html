<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>100 Percent</title>

<style>
/* =========================================================
   UI/BRANDING (VISUAL ONLY)
   Fixes:
   1) Flag bigger + uniform
   2) Answers not all-caps
   3) Brighter / more energy with electric blue accents
   ========================================================= */
:root{
  /* Base */
  --bg:#141414;
  --panel:#1b1b1b;              /* slightly brighter than before */
  --panel2:#212121;             /* brighter surface layer */
  --panel3:#262626;             /* used for emphasized zones */
  --border:rgba(255,255,255,.11);

  /* Text */
  --text:#f7f8fb;
  --muted:rgba(247,248,251,.74);

  /* Accent */
  --blue:#2f80ff;
  --blue2:#1b5cff;
  --blueGlow:rgba(47,128,255,.25);

  /* Status */
  --good:#2ee59d;
  --bad:#ff4d6d;

  /* Motion */
  --t:170ms;
  --ease:cubic-bezier(.2,.9,.2,1);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, "Inter", "Segoe UI", Roboto, Arial, sans-serif;
  color:var(--text);

  /* Brighter energy without childish gradients */
  background:
    radial-gradient(900px 520px at 18% -12%, rgba(47,128,255,.22), transparent 62%),
    radial-gradient(780px 560px at 86% 8%, rgba(255,255,255,.05), transparent 55%),
    radial-gradient(720px 520px at 82% 0%, rgba(46,229,157,.08), transparent 58%),
    linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,0)),
    var(--bg);
}

.wrap{
  max-width:560px;
  margin:auto;
  padding:14px;
}

.screen{ display:none; }
.screen.active{ display:block; }

/* Home centered only */
#home.active{
  min-height:100vh;
  display:flex;
  align-items:center;
}

/* Panels */
.card{
  width:100%;
  border:1px solid var(--border);
  border-radius:18px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  overflow:hidden;
  box-shadow: 0 22px 60px rgba(0,0,0,.38);
}

.header{
  padding:16px 16px 14px;
  border-bottom:1px solid var(--border);
  background:
    linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.08));
  backdrop-filter: blur(6px);
}

.content{ padding:14px; }

/* HOME globe */
.homeCard{
  position:relative;
  isolation:isolate;
}
.homeCard::before{
  content:"";
  position:absolute;
  right:-60px;
  top:-60px;
  width:430px;
  height:430px;
  pointer-events:none;
  z-index:-1;
  opacity:.18;
  background-repeat:no-repeat;
  background-size:contain;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 420 420'%3E%3Cdefs%3E%3CradialGradient id='o' cx='38%25' cy='30%25' r='65%25'%3E%3Cstop offset='0' stop-color='%23ffffff' stop-opacity='.06'/%3E%3Cstop offset='.55' stop-color='%23000000' stop-opacity='.55'/%3E%3Cstop offset='1' stop-color='%23000000' stop-opacity='.92'/%3E%3C/radialGradient%3E%3CradialGradient id='rim' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='.72' stop-color='%232f80ff' stop-opacity='0'/%3E%3Cstop offset='1' stop-color='%232f80ff' stop-opacity='.55'/%3E%3C/radialGradient%3E%3ClinearGradient id='grid' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23ffffff' stop-opacity='.14'/%3E%3Cstop offset='1' stop-color='%23ffffff' stop-opacity='.06'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='210' cy='210' r='160' fill='url(%23o)'/%3E%3Ccircle cx='210' cy='210' r='164' fill='none' stroke='url(%23rim)' stroke-width='10'/%3E%3Cg fill='none' stroke='url(%23grid)' stroke-width='2'%3E%3Cpath d='M50 210c60-80 260-80 320 0'/%3E%3Cpath d='M50 210c60 80 260 80 320 0'/%3E%3Cpath d='M210 50c80 60 80 260 0 320'/%3E%3Cpath d='M210 50c-80 60-80 260 0 320'/%3E%3Cpath d='M90 150c45 30 195 30 240 0'/%3E%3Cpath d='M90 270c45-30 195-30 240 0'/%3E%3C/g%3E%3C/svg%3E");
}

.brandRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
.brandLeft{display:flex;align-items:flex-start;gap:12px;}
.brandTitle{display:flex;flex-direction:column;gap:8px;}

.titleStack{display:flex;flex-direction:column;gap:6px;}
.titleStack .title{
  margin:0;
  font-weight:1000;
  letter-spacing:-.6px;
  line-height:1.05;
  font-size:24px;
}
.titleStack .subtitle{
  margin:0;
  color:rgba(247,248,251,.88);
  font-size:13px;
  line-height:1.35;
}
.titleStack .secondary{
  margin:0;
  color:var(--muted);
  font-size:12.5px;
  line-height:1.35;
}

.modeNotes{
  margin-top:6px;
  color:rgba(247,248,251,.80);
  font-size:12.5px;
  line-height:1.35;
}
.modeNotes strong{ color:rgba(247,248,251,.94); }

.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:999px;
  border:1px solid rgba(47,128,255,.25);
  background:rgba(47,128,255,.08);
  color:rgba(247,248,251,.82);
  font-size:12px;
  user-select:none;
}
.dot{
  width:8px;height:8px;border-radius:999px;
  background:var(--blue);
  box-shadow:0 0 18px rgba(47,128,255,.55);
}

/* Buttons */
.btn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:900;
  cursor:pointer;
  transition: transform var(--t) var(--ease), background var(--t) var(--ease), border-color var(--t) var(--ease);
  will-change:transform;
}
.btn:active{ transform:scale(.98); }

/* IMPORTANT: do not force uppercase on answers anymore */
.choice{
  text-transform:none;          /* <-- fix all-caps issue */
  letter-spacing:.1px;
  font-weight:800;
  font-size:16px;
  padding:14px 14px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  border-color: rgba(255,255,255,.16);
}
.choice:hover{
  border-color: rgba(47,128,255,.35);
  box-shadow: 0 0 0 3px rgba(47,128,255,.10);
}

/* Primary action button */
.btnPrimary{
  background: linear-gradient(180deg, rgba(47,128,255,.70), rgba(27,92,255,.46));
  border-color: rgba(47,128,255,.55);
  box-shadow: 0 18px 42px rgba(47,128,255,.20);
}
.btnPrimary:hover{
  background: linear-gradient(180deg, rgba(47,128,255,.76), rgba(27,92,255,.50));
}

/* Hardmode = darker, more dangerous */
.btnHard{
  background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(255,255,255,.04));
  border-color: rgba(255,255,255,.16);
  box-shadow:
    inset 0 0 0 1px rgba(47,128,255,.12),
    0 10px 30px rgba(0,0,0,.25);
}
.btnHard:hover{
  border-color: rgba(47,128,255,.30);
}

/* Subtle button */
.btnSubtle{
  font-weight:900;
  font-size:14px;
  padding:12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.04);
  color:rgba(247,248,251,.84);
}

.bigQuickfire{ padding:18px; font-size:18px; font-weight:1000; }
.bigPlay{ padding:18px; font-size:18px; font-weight:1000; }

.row{display:flex;gap:10px;margin-top:10px;}
.row .btn{flex:1;}

/* HUD */
.hudRow{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  align-items:flex-end;
}
.hudBlock{display:flex;flex-direction:column;gap:3px;}
.hudMain{font-weight:1000;font-size:14px;letter-spacing:.4px;}
.hudSub{color:var(--muted);font-size:12px;letter-spacing:.2px;}

/* =========================================================
   1) FLAGS TOO SMALL â€” make bigger, still uniform
   - fixed height for consistency
   - object-fit contain preserves aspect ratio
   - brighter frame + blue glow = more focus
   ========================================================= */
.flagWrap{
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(47,128,255,.26);
  background:
    radial-gradient(380px 180px at 50% 45%, rgba(47,128,255,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20)),
    rgba(0,0,0,.22);

  height: 250px;               /* increased noticeably */
  display:flex;
  align-items:center;
  justify-content:center;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.07),
    0 18px 48px rgba(0,0,0,.35),
    0 0 0 4px rgba(47,128,255,.06);
}

#flag{
  width:100%;
  height:100%;
  object-fit:contain;
  object-position:center;
  display:block;
  padding:14px;                /* consistent framing */
  filter: saturate(1.10) contrast(1.05); /* bold/bright but not distorted */
}

/* Choices */
.choices{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.choice.correct{outline:2px solid rgba(46,229,157,.88);}
.choice.wrong{outline:2px solid rgba(255,77,109,.88);}

/* Status */
.status{
  margin-top:10px;
  font-weight:1000;
  letter-spacing:.4px;
}
.status.good{color:var(--good);}
.status.bad{color:var(--bad);}
.status.neutral{color:var(--muted);}

/* End screen */
.resultBig{
  font-size:56px;
  font-weight:1000;
  text-align:center;
  letter-spacing:-1px;
}
.resultSub{
  text-align:center;
  color:var(--muted);
  margin-top:6px;
  font-size:13px;
}
.note{
  text-align:center;
  color:rgba(247,248,251,.82);
  margin-top:10px;
  font-size:13px;
  letter-spacing:.1px;
}
.divider{height:1px;background:var(--border);margin:14px 0;}

.perfectGlow{ animation: glow 900ms ease-in-out infinite alternate; }
@keyframes glow{
  from{ text-shadow: 0 0 0 rgba(46,229,157,0); }
  to{ text-shadow: 0 0 22px rgba(46,229,157,.26); }
}
.confetti{position:relative;height:0;}
.confetti i{
  position:absolute; top:-6px;
  width:8px;height:14px;border-radius:4px;
  opacity:0; animation: pop 900ms ease forwards;
}
@keyframes pop{
  0%{ transform:translateY(0) rotate(0deg); opacity:0; }
  15%{ opacity:1; }
  100%{ transform:translateY(120px) rotate(240deg); opacity:0; }
}

.footerThanks{
  margin-top:12px;
  text-align:center;
  color:rgba(247,248,251,.58);
  font-size:12px;
}

/* Mobile tuning: bigger flag but keep answers visible */
@media (max-width: 420px){
  .wrap{ padding:12px; }
  .flagWrap{ height: 220px; }  /* still bigger than before, but safe */
  .choice{ font-size:15px; padding:13px; }
  .bigQuickfire, .bigPlay{ font-size:17px; }
}
</style>
</head>

<body>
<div class="wrap">

<!-- HOME -->
<section id="home" class="screen active">
  <div class="card homeCard">
    <div class="header">
      <div class="brandRow">
        <div class="brandLeft">
          <div class="brandTitle">
            <div class="titleStack">
              <h1 class="title">100% Percent</h1>
              <p class="subtitle">One mistake ends the run.</p>
              <p class="secondary">Can you go perfect?</p>
            </div>

            <div class="modeNotes">
              <strong>Quickfire:</strong> Structured challenge. Learn the pattern.<br/>
              <strong>Hardmode:</strong> Fully random. No mercy.
            </div>
          </div>
        </div>

        <div class="pill"><span class="dot"></span><span>Flags</span></div>
      </div>
    </div>

    <div class="content">
      <button id="btnQuickfire" class="btn btnPrimary bigQuickfire">Quickfire</button>
      <div class="row">
        <button id="btnHardmode" class="btn btnHard">Hardmode</button>
      </div>
      <div class="footerThanks">The world is the arena.</div>
    </div>
  </div>
</section>

<!-- PLAY -->
<section id="play" class="screen">
  <div class="card">
    <div class="header">
      <div class="hudRow">
        <div class="hudBlock">
          <div id="hudMode" class="hudMain">Quickfire</div>
          <div id="hudProgress" class="hudSub">0 / 30</div>
          <div id="hudPB" class="hudSub">PB: 0 / 30</div>
          <div id="hudBestTime" class="hudSub">Best Time (30/30): â€”</div>
        </div>
        <div class="hudBlock" style="text-align:right;">
          <div class="hudMain">Time</div>
          <div id="hudTime" class="hudSub">0:00.0</div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="flagWrap"><img id="flag" alt="flag"></div>
      <div class="choices" id="choices"></div>
      <div id="status" class="status neutral"></div>
      <div id="note" class="note"></div>

      <div class="row">
        <button id="btnQuit" class="btn">Home</button>
        <button id="btnRestartRun" class="btn">Restart</button>
      </div>
    </div>
  </div>
</section>

<!-- END -->
<section id="end" class="screen">
  <div class="card">
    <div class="header">
      <h2 id="endTitle" class="hudMain" style="margin:0;">Run failed</h2>
    </div>

    <div class="content">
      <div id="confetti" class="confetti" aria-hidden="true"></div>

      <div class="resultBig" id="endPercent">0%</div>
      <div class="resultSub" id="endLine">Score: 0 / 30 (0%)</div>
      <div class="resultSub" id="endPBLine">Personal Best: 0%</div>
      <div class="resultSub" id="endTimeLine">Time: 0:00.0</div>
      <div class="resultSub" id="endBestTimeLine">Best Time (30/30): â€”</div>

      <div class="note" id="endTryAgain"></div>

      <div class="divider"></div>

      <button id="btnPlayAgain" class="btn btnPrimary bigPlay">Play Again</button>

      <div class="row">
        <button id="btnShare" class="btn btnSubtle">Share / Copy</button>
        <button id="btnEndHome" class="btn">Home</button>
      </div>
    </div>
  </div>
</section>

</div>

<script>
/* ---------------- STATE ---------------- */
let mode="quickfire";
let category="flags";
let targetTotal=30;
let questions=[];
let idx=0;
let correct=0;
let locked=false;
let streak=0;

/* PB at the START of the run */
let runPBStart=0;

/* timer */
let runStartMs=0;
let runEndMs=0;
let timerHandle=null;

/* ---------------- ELEMENTS ---------------- */
const screens={
  home:document.getElementById("home"),
  play:document.getElementById("play"),
  end:document.getElementById("end"),
};
const flag=document.getElementById("flag");
const choicesDiv=document.getElementById("choices");
const statusEl=document.getElementById("status");
const noteEl=document.getElementById("note");

const hudMode=document.getElementById("hudMode");
const hudProgress=document.getElementById("hudProgress");
const hudPB=document.getElementById("hudPB");
const hudTime=document.getElementById("hudTime");
const hudBestTime=document.getElementById("hudBestTime");

const endTitle=document.getElementById("endTitle");
const endPercent=document.getElementById("endPercent");
const endLine=document.getElementById("endLine");
const endPBLine=document.getElementById("endPBLine");
const endTimeLine=document.getElementById("endTimeLine");
const endBestTimeLine=document.getElementById("endBestTimeLine");
const endTryAgain=document.getElementById("endTryAgain");
const confettiEl=document.getElementById("confetti");

/* buttons */
const btnQuickfire=document.getElementById("btnQuickfire");
const btnHardmode=document.getElementById("btnHardmode");
const btnQuit=document.getElementById("btnQuit");
const btnRestartRun=document.getElementById("btnRestartRun");
const btnPlayAgain=document.getElementById("btnPlayAgain");
const btnEndHome=document.getElementById("btnEndHome");
const btnShare=document.getElementById("btnShare");

/* ---------------- HELPERS ---------------- */
function show(screenName){
  Object.values(screens).forEach(x=>x.classList.remove("active"));
  screens[screenName].classList.add("active");
  window.scrollTo(0,0);
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function pbKey(){ return `pb_${category}_${mode}`; }
function getPB(){ return Number(localStorage.getItem(pbKey())) || 0; }
function setPB(v){ localStorage.setItem(pbKey(), String(v)); }

/* Best time ONLY for perfect runs */
function bestTimeKey(){ return `bestTimePerfect_${category}_${mode}`; }
function getBestTimeMs(){
  const v=Number(localStorage.getItem(bestTimeKey()));
  return Number.isFinite(v) && v>0 ? v : null;
}
function setBestTimeMs(ms){ localStorage.setItem(bestTimeKey(), String(ms)); }

function formatMs(ms){
  ms=Math.max(0,ms);
  const totalSeconds=ms/1000;
  const minutes=Math.floor(totalSeconds/60);
  const seconds=totalSeconds-minutes*60;
  const secInt=Math.floor(seconds);
  const tenths=Math.floor((seconds-secInt)*10);
  return `${minutes}:${String(secInt).padStart(2,"0")}.${tenths}`;
}

function renderHud(){
  hudMode.textContent=(mode==="hardmode") ? "Hardmode" : "Quickfire";
  hudProgress.textContent=`${correct} / ${targetTotal}`;
  hudPB.textContent=`PB: ${getPB()} / ${targetTotal}`;
  const bt=getBestTimeMs();
  hudBestTime.textContent=`Best Time (30/30): ${bt ? formatMs(bt) : "â€”"}`;
}

function startTimer(){
  stopTimer();
  runStartMs=Date.now();
  runEndMs=0;
  hudTime.textContent="0:00.0";
  timerHandle=setInterval(()=>{ hudTime.textContent=formatMs(Date.now()-runStartMs); },100);
}
function stopTimer(){ if(timerHandle) clearInterval(timerHandle); timerHandle=null; }
function finalizeTimer(){ runEndMs=Date.now(); stopTimer(); return runEndMs-runStartMs; }

/* FAIL messaging (unchanged gameplay; just text rules already agreed) */
function pickTryAgainLine(score,total){
  const pct=Math.round((score/total)*100);
  if(pct>=90) return "Brutal.";
  if(pct>=70) return "So close.";
  if(pct>=30) return "Youâ€™re improving. Keep pushing.";
  return "Warm up. Youâ€™ve got this.";
}

/* Confetti */
function burstConfetti(){
  confettiEl.innerHTML="";
  const pieces=18;
  for(let i=0;i<pieces;i++){
    const p=document.createElement("i");
    p.style.left=(Math.random()*100)+"%";
    p.style.top=(-8-Math.random()*18)+"px";
    p.style.animationDelay=(Math.random()*120)+"ms";
    p.style.animationDuration=(700+Math.random()*500)+"ms";
    p.style.transform=`rotate(${Math.floor(Math.random()*280)}deg)`;
    p.style.background=(Math.random()<0.5) ? "rgba(47,128,255,.95)" : "rgba(46,229,157,.90)";
    confettiEl.appendChild(p);
  }
}

/* Preload first flag (performance) */
function preloadImage(src){
  return new Promise((resolve, reject)=>{
    if(!src) return reject(new Error("Missing image_url"));
    const img=new Image();
    img.onload=()=>resolve(true);
    img.onerror=()=>reject(new Error("Failed to load flag image"));
    img.src=src;
  });
}

/* ---------------- GAME FLOW ---------------- */
async function startRun(newMode){
  mode=newMode;
  runPBStart=getPB();
  correct=0;
  idx=0;
  streak=0;
  locked=false;

  show("play");
  renderHud();

  noteEl.textContent="";
  statusEl.textContent="Loading...";
  statusEl.className="status neutral";

  startTimer();

  try{
    const res=await fetch(`/api/questionset?mode=${mode}&category=${category}`, {cache:"no-store"});
    if(!res.ok){
      const txt=await res.text();
      throw new Error(`API ${res.status}: ${txt.slice(0,200)}`);
    }

    const data=await res.json();
    if(data.error) throw new Error(data.error);

    questions=data.questions || [];
    targetTotal=data.totalPlanned || (mode==="hardmode" ? 195 : 30);

    if(!Array.isArray(questions) || questions.length===0){
      throw new Error("No questions returned from API.");
    }

    await preloadImage(questions[0].image_url);

    renderHud();
    showQuestion();

  }catch(e){
    stopTimer();
    statusEl.className="status bad";
    statusEl.textContent="Could not load. Restart.";
    noteEl.textContent=String(e.message || e);
  }
}

function showQuestion(){
  statusEl.textContent="";
  statusEl.className="status neutral";
  noteEl.textContent="";
  locked=false;
  renderHud();

  const q=questions[idx];
  if(!q || !q.image_url || !Array.isArray(q.choices)){
    return endRun("Run ended");
  }

  flag.removeAttribute("src");
  flag.src=q.image_url;

  choicesDiv.innerHTML="";
  q.choices.forEach((txt,i)=>{
    const b=document.createElement("button");
    b.className="btn choice"; /* choice styling controls casing */
    b.textContent=txt;        /* keep original casing from API */
    b.onclick=()=>answer(i,b);
    choicesDiv.appendChild(b);
  });
}

function answer(i,btn){
  if(locked) return;
  locked=true;

  const q=questions[idx];
  const allBtns=[...document.querySelectorAll(".choice")];
  allBtns.forEach(b=>b.disabled=true);

  if(i===q.correct_index){
    btn.classList.add("correct");
    correct++;
    streak++;

    if(correct>getPB()) setPB(correct);

    statusEl.className="status good";
    statusEl.textContent=(streak>=3) ? `STREAK ${streak}` : "CORRECT";

    renderHud();

    setTimeout(()=>{
      idx++;
      if(idx>=questions.length) return endRun("PERFECT RUN");
      showQuestion();
    },380);

  }else{
    streak=0;
    statusEl.className="status bad";
    statusEl.textContent="FAILED";
    btn.classList.add("wrong");

    if(mode==="quickfire"){
      const correctBtn=allBtns[q.correct_index];
      if(correctBtn) correctBtn.classList.add("correct");
      noteEl.textContent=`Correct: ${q.choices[q.correct_index]}`;
    }

    setTimeout(()=>endRun("Run failed"),850);
  }
}

function endRun(title){
  const elapsedMs=finalizeTimer();
  const pct=clamp(Math.round((correct/targetTotal)*100),0,100);
  const perfect=(correct===targetTotal);

  if(perfect){
    const currentBest=getBestTimeMs();
    if(!currentBest || elapsedMs<currentBest){
      setBestTimeMs(elapsedMs);
    }
  }

  renderHud();
  show("end");

  if(perfect){
    endTitle.textContent="PERFECT. 100%.";
    endPercent.classList.add("perfectGlow");
    burstConfetti();
    endTryAgain.textContent="Elite. Lock it in.";
  }else{
    endTitle.textContent=title;
    endPercent.classList.remove("perfectGlow");
    confettiEl.innerHTML="";
    endTryAgain.textContent=pickTryAgainLine(correct,targetTotal);
  }

  endPercent.textContent=`${pct}%`;
  endLine.textContent=`Score: ${correct} / ${targetTotal} (${pct}%)`;

  if(perfect){
    endPBLine.textContent=`Best: ${getPB()} / ${targetTotal}`;
  }else{
    const currentPercent = pct;
    const previousBestPercent = Math.round((runPBStart/targetTotal)*100);
    if(currentPercent > previousBestPercent){
      const gain = currentPercent - previousBestPercent;
      endPBLine.textContent = `ðŸ”¼ New Personal Best (+${gain})`;
    }else{
      endPBLine.textContent = `Personal Best: ${previousBestPercent}%`;
    }
  }

  endTimeLine.textContent=`Time: ${formatMs(elapsedMs)}`;
  const bt=getBestTimeMs();
  endBestTimeLine.textContent=`Best Time (30/30): ${bt ? formatMs(bt) : "â€”"}`;

  setTimeout(()=>btnPlayAgain.focus(),80);
}

/* ---------------- SHARE ---------------- */
function buildShareText(){
  const pct=clamp(Math.round((correct/targetTotal)*100),0,100);
  const url=window.location.origin;
  const modeLabel=(mode==="hardmode") ? "Hardmode" : "Quickfire";
  return `I scored ${pct}% on 100 Percent (Flags ${modeLabel}). Can you beat me? ${url}`;
}
async function shareScore(){
  const text=buildShareText();

  if(navigator.share){
    try{
      await navigator.share({title:"100 Percent", text});
      btnShare.textContent="Shared";
      setTimeout(()=>btnShare.textContent="Share / Copy",1200);
      return;
    }catch(e){}
  }

  try{
    await navigator.clipboard.writeText(text);
    btnShare.textContent="Copied";
    setTimeout(()=>btnShare.textContent="Share / Copy",1200);
  }catch(e){
    window.prompt("Copy this:", text);
  }
}

/* ---------------- BUTTONS ---------------- */
btnQuickfire.onclick=()=>startRun("quickfire");
btnHardmode.onclick=()=>startRun("hardmode");
btnQuit.onclick=()=>{ stopTimer(); show("home"); };
btnRestartRun.onclick=()=>startRun(mode);
btnPlayAgain.onclick=()=>startRun(mode);
btnEndHome.onclick=()=>show("home");
btnShare.onclick=()=>shareScore();
</script>
</body>
</html>
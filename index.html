<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>100 Percent</title>

<style>
:root{
  --bg:#0b0d12;
  --text:#f3f6ff;
  --muted:rgba(243,246,255,.7);
  --border:rgba(243,246,255,.12);
  --accent:#7c5cff;
  --good:#2ee59d;
  --bad:#ff4d6d;
}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:520px;margin:auto;padding:16px;}
.card{
  border:1px solid var(--border);
  border-radius:18px;
  background:rgba(255,255,255,.03);
  overflow:hidden;
}
.header{padding:16px;border-bottom:1px solid var(--border);}
.content{padding:14px;}

.btn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
  color:white;
  font-weight:700;
  cursor:pointer;
}
.btnPrimary{
  background:rgba(124,92,255,.4);
}
.row{display:flex;gap:10px;margin-top:10px;}
.row .btn{flex:1;}

.screen{display:none;}
.screen.active{display:block;}

.flagWrap{border-radius:14px;overflow:hidden;border:1px solid var(--border);}
#flag{width:100%;display:block;}

.choices{margin-top:10px;display:flex;flex-direction:column;gap:10px;}
.choice.correct{outline:2px solid var(--good);}
.choice.wrong{outline:2px solid var(--bad);}

.status{margin-top:10px;font-weight:800;}
.status.good{color:var(--good);}
.status.bad{color:var(--bad);}
.status.neutral{color:var(--muted);}

.resultBig{
  font-size:36px;
  font-weight:900;
  text-align:center;
}
.resultSub{
  text-align:center;
  color:var(--muted);
  margin-top:6px;
}
.note{
  text-align:center;
  color:var(--muted);
  margin-top:10px;
  font-size:14px;
}
.divider{
  height:1px;
  background:var(--border);
  margin:14px 0;
}
</style>
</head>

<body>
<div class="wrap">

<!-- HOME -->
<section id="home" class="screen active">
  <div class="card">
    <div class="header">
      <h1>100 Percent</h1>
      <p style="color:var(--muted)">One mistake ends your run.</p>
    </div>
    <div class="content">
      <button id="btnQuickfire" class="btn btnPrimary">Quickfire (30)</button>
      <div class="row">
        <button id="btnHardmode" class="btn">Hardmode (195)</button>
      </div>
    </div>
  </div>
</section>

<!-- PLAY -->
<section id="play" class="screen">
  <div class="card">
    <div class="header">
      <div id="hudMode">Quickfire</div>
      <div id="hudProgress" style="color:var(--muted)">0 / 30</div>
      <div id="hudPB" style="color:var(--muted)">PB: 0 / 30</div>
    </div>

    <div class="content">
      <div class="flagWrap">
        <img id="flag"/>
      </div>
      <div class="choices" id="choices"></div>
      <div id="status" class="status neutral"></div>
      <div id="note" class="note"></div>

      <div class="row">
        <button id="btnQuit" class="btn">Home</button>
        <button id="btnRestartRun" class="btn">Restart</button>
      </div>
    </div>
  </div>
</section>

<!-- END -->
<section id="end" class="screen">
  <div class="card">
    <div class="header">
      <h2 id="endTitle">Run failed</h2>
    </div>

    <div class="content">

      <div class="resultBig" id="endPercent">0%</div>

      <div class="resultSub" id="endLine">
        Score: 0 / 30 (0%)
      </div>

      <div class="resultSub" id="endPBLine">
        Best: 0 / 30
      </div>

      <div class="note" id="endTryAgain"></div>

      <div class="divider"></div>

      <button id="btnPlayAgain" class="btn btnPrimary" style="font-size:18px;">
        Play again
      </button>

      <div class="row">
        <button id="btnEndHome" class="btn">Home</button>
      </div>

    </div>
  </div>
</section>

</div>

<script>
let mode="quickfire";
let category="flags";
let targetTotal=30;
let questions=[];
let idx=0;
let correct=0;
let locked=false;

const TRY_AGAIN_LINES=[
"So close â€” run it back ðŸ˜„",
"That one doesnâ€™t countâ€¦ again! ðŸ˜…",
"Youâ€™ve got this. One more try ðŸ‘€",
"Warm-up round. Now lock in ðŸ”’",
"Your brainâ€™s loadingâ€¦ try again âš¡",
"That was practice. Next one is 100% âœ…"
];

function pickTryAgainLine(){
 return TRY_AGAIN_LINES[Math.floor(Math.random()*TRY_AGAIN_LINES.length)];
}

const screens={
home:document.getElementById("home"),
play:document.getElementById("play"),
end:document.getElementById("end")
};

const flag=document.getElementById("flag");
const choicesDiv=document.getElementById("choices");
const statusEl=document.getElementById("status");
const noteEl=document.getElementById("note");

const hudMode=document.getElementById("hudMode");
const hudProgress=document.getElementById("hudProgress");
const hudPB=document.getElementById("hudPB");

const endTitle=document.getElementById("endTitle");
const endPercent=document.getElementById("endPercent");
const endLine=document.getElementById("endLine");
const endPBLine=document.getElementById("endPBLine");
const endTryAgain=document.getElementById("endTryAgain");

function show(s){
 Object.values(screens).forEach(x=>x.classList.remove("active"));
 screens[s].classList.add("active");
}

function pbKey(){return `pb_${category}_${mode}`;}
function getPB(){return Number(localStorage.getItem(pbKey()))||0;}
function setPB(v){localStorage.setItem(pbKey(),v);}

function renderHud(){
 hudMode.textContent=mode==="hardmode"?"Hardmode":"Quickfire";
 hudProgress.textContent=`${correct} / ${targetTotal}`;
 hudPB.textContent=`PB: ${getPB()} / ${targetTotal}`;
}

async function startRun(m){
 mode=m;
 correct=0;
 idx=0;
 show("play");

 const res=await fetch(`/api/questionset?mode=${mode}&category=${category}`,{cache:"no-store"});
 const data=await res.json();

 questions=data.questions;
 targetTotal=data.totalPlanned;
 renderHud();
 showQuestion();
}

function showQuestion(){
 statusEl.textContent="";
 noteEl.textContent="";
 locked=false;
 renderHud();

 const q=questions[idx];
 flag.src=q.image_url;
 choicesDiv.innerHTML="";

 q.choices.forEach((txt,i)=>{
   const b=document.createElement("button");
   b.className="btn choice";
   b.textContent=txt;
   b.onclick=()=>answer(i,b);
   choicesDiv.appendChild(b);
 });
}

function highlightCorrect(correctIndex,clicked,q){
 clicked.classList.add("wrong");
 const btns=[...document.querySelectorAll(".choice")];
 btns[correctIndex].classList.add("correct");
 noteEl.textContent=`Correct answer: ${q.choices[correctIndex]}`;
}

function answer(i,btn){
 if(locked)return;
 locked=true;

 const q=questions[idx];
 const buttons=[...document.querySelectorAll(".choice")];
 buttons.forEach(b=>b.disabled=true);

 if(i===q.correct_index){
   btn.classList.add("correct");
   statusEl.className="status good";
   statusEl.textContent="âœ… Correct";
   correct++;
   if(correct>getPB())setPB(correct);

   setTimeout(()=>{
    idx++;
    if(idx>=questions.length)return endRun("ðŸŽ‰ PERFECT RUN");
    showQuestion();
   },400);

 }else{
   statusEl.className="status bad";
   statusEl.textContent="âŒ Wrong";

   if(mode==="quickfire"){
     highlightCorrect(q.correct_index,btn,q);
   }else{
     btn.classList.add("wrong");
   }

   setTimeout(()=>endRun("âŒ Run failed"),900);
 }
}

function endRun(title){
 const pct=Math.round((correct/targetTotal)*100);

 show("end");
 endTitle.textContent=title;
 endPercent.textContent=`${pct}%`;
 endLine.textContent=`Score: ${correct} / ${targetTotal} (${pct}%)`;
 endPBLine.textContent=`Best: ${getPB()} / ${targetTotal}`;
 endTryAgain.textContent=pickTryAgainLine();
}

document.getElementById("btnQuickfire").onclick=()=>startRun("quickfire");
document.getElementById("btnHardmode").onclick=()=>startRun("hardmode");
document.getElementById("btnQuit").onclick=()=>show("home");
document.getElementById("btnRestartRun").onclick=()=>startRun(mode);
document.getElementById("btnPlayAgain").onclick=()=>startRun(mode);
document.getElementById("btnEndHome").onclick=()=>show("home");

</script>
</body>
</html>

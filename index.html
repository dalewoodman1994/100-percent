<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>100 Percent</title>

<style>
:root{
  --bg:#0b0d12;
  --text:#f3f6ff;
  --muted:rgba(243,246,255,.7);
  --border:rgba(243,246,255,.12);
  --accent:#7c5cff;
  --good:#2ee59d;
  --bad:#ff4d6d;
}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:520px;margin:auto;padding:14px;}
.card{
  border:1px solid var(--border);
  border-radius:16px;
  background:rgba(255,255,255,.03);
  overflow:hidden;
}
.header{padding:16px;border-bottom:1px solid var(--border);}
.content{padding:14px;}

.btn{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  color:white;
  font-weight:700;
  cursor:pointer;
}
.btnPrimary{
  background:rgba(124,92,255,.45);
}

.bigPlay{
  padding:18px !important;
  font-size:22px !important;
  font-weight:900;
}

.row{display:flex;gap:10px;margin-top:10px;}
.row .btn{flex:1;}

.screen{display:none;}
.screen.active{display:block;}

.flagWrap{
  border-radius:14px;
  overflow:hidden;
  border:1px solid var(--border);
}
#flag{width:100%;display:block;}

.choices{margin-top:10px;display:flex;flex-direction:column;gap:10px;}

.choice.correct{outline:2px solid var(--good);}
.choice.wrong{outline:2px solid var(--bad);}

.status{margin-top:10px;font-weight:800;}
.status.good{color:var(--good);}
.status.bad{color:var(--bad);}
.status.neutral{color:var(--muted);}

.resultBig{
  font-size:42px;
  font-weight:1000;
  text-align:center;
}

.resultSub{
  text-align:center;
  color:var(--muted);
  margin-top:6px;
}

.note{
  text-align:center;
  margin-top:10px;
  color:var(--muted);
  font-size:14px;
}

.divider{
  height:1px;
  background:var(--border);
  margin:14px 0;
}
</style>
</head>

<body>
<div class="wrap">

<!-- HOME -->
<section id="home" class="screen active">
<div class="card">
<div class="header">
<h1>100 Percent</h1>
<p style="color:var(--muted)">One mistake ends your run.</p>
</div>
<div class="content">
<button id="btnQuickfire" class="btn btnPrimary">Quickfire (30)</button>
<div class="row">
<button id="btnHardmode" class="btn">Hardmode (195)</button>
</div>
</div>
</div>
</section>

<!-- PLAY -->
<section id="play" class="screen">
<div class="card">
<div class="header">
<div id="hudMode">Quickfire</div>
<div id="hudProgress" style="color:var(--muted)">0 / 30</div>
<div id="hudPB" style="color:var(--muted)">PB: 0 / 30</div>
</div>

<div class="content">
<div class="flagWrap"><img id="flag"></div>
<div class="choices" id="choices"></div>
<div id="status" class="status neutral"></div>
<div id="note" class="note"></div>

<div class="row">
<button id="btnQuit" class="btn">Home</button>
<button id="btnRestartRun" class="btn">Restart</button>
</div>
</div>
</div>
</section>

<!-- END -->
<section id="end" class="screen">
<div class="card">
<div class="header">
<h2 id="endTitle">Run failed</h2>
</div>

<div class="content">

<div class="resultBig" id="endPercent">0%</div>

<div class="resultSub" id="endLine">
Score: 0 / 30 (0%)
</div>

<div class="resultSub" id="endPBLine">
Best: 0 / 30
</div>

<div class="note" id="endTryAgain"></div>

<div class="divider"></div>

<!-- â­ UI tweak: BIG visual restart target -->
<button id="btnPlayAgain" class="btn btnPrimary bigPlay">
PLAY AGAIN
</button>

<div class="row">
<button id="btnEndHome" class="btn">Home</button>
</div>

</div>
</div>
</section>

</div>

<script>

let mode="quickfire";
let category="flags";
let targetTotal=30;
let questions=[];
let idx=0;
let correct=0;
let locked=false;

const screens={
home:home,
play:play,
end:end
};

const flag=document.getElementById("flag");
const choicesDiv=choices;
const statusEl=status;
const noteEl=note;
const hudMode=document.getElementById("hudMode");
const hudProgress=document.getElementById("hudProgress");
const hudPB=document.getElementById("hudPB");

const endTitle=endTitle;
const endPercent=endPercent;
const endLine=endLine;
const endPBLine=endPBLine;
const endTryAgain=endTryAgain;

function show(s){
 Object.values(screens).forEach(x=>x.classList.remove("active"));
 screens[s].classList.add("active");
}

function pbKey(){return `pb_${category}_${mode}`;}
function getPB(){return Number(localStorage.getItem(pbKey()))||0;}
function setPB(v){localStorage.setItem(pbKey(),v);}

function renderHud(){
 hudMode.textContent=mode==="hardmode"?"Hardmode":"Quickfire";
 hudProgress.textContent=`${correct} / ${targetTotal}`;
 hudPB.textContent=`PB: ${getPB()} / ${targetTotal}`;
}

/* â­ NEAR MISS PSYCHOLOGY */
function pickTryAgainLine(score,total){
 const pct=Math.round((score/total)*100);

 if(score>=total-1) return "ONE away from 100% ðŸ˜± run it back!";
 if(pct>=80) return "You were SO closeâ€¦ next run is it ðŸ”¥";
 if(pct>=60) return "You're getting sharp ðŸ‘€ go again!";
 if(pct>=40) return "Nice progress â€” keep pushing ðŸ’ª";
 return "Warm-up round ðŸ˜„ try again!";
}

async function startRun(m){
 mode=m; idx=0; correct=0;
 show("play");

 const res=await fetch(`/api/questionset?mode=${mode}&category=${category}`,{cache:"no-store"});
 const data=await res.json();
 questions=data.questions;
 targetTotal=data.totalPlanned;

 renderHud();
 showQuestion();
}

function showQuestion(){
 statusEl.textContent="";
 noteEl.textContent="";
 locked=false;
 renderHud();

 const q=questions[idx];
 flag.src=q.image_url;
 choicesDiv.innerHTML="";

 q.choices.forEach((txt,i)=>{
   const b=document.createElement("button");
   b.className="btn choice";
   b.textContent=txt;
   b.onclick=()=>answer(i,b);
   choicesDiv.appendChild(b);
 });
}

function answer(i,btn){
 if(locked)return;
 locked=true;

 const q=questions[idx];
 [...document.querySelectorAll(".choice")].forEach(b=>b.disabled=true);

 if(i===q.correct_index){
   btn.classList.add("correct");
   statusEl.className="status good";
   statusEl.textContent="âœ… Correct";
   correct++;
   if(correct>getPB())setPB(correct);

   setTimeout(()=>{
    idx++;
    if(idx>=questions.length) return endRun("ðŸŽ‰ PERFECT RUN");
    showQuestion();
   },400);

 }else{
   statusEl.className="status bad";
   statusEl.textContent="âŒ Wrong";

   btn.classList.add("wrong");

   if(mode==="quickfire"){
     document.querySelectorAll(".choice")[q.correct_index].classList.add("correct");
     noteEl.textContent=`Correct answer: ${q.choices[q.correct_index]}`;
   }

   setTimeout(()=>endRun("âŒ Run failed"),900);
 }
}

function endRun(title){
 const pct=Math.round((correct/targetTotal)*100);

 show("end");

 endTitle.textContent=title;
 endPercent.textContent=`${pct}%`;
 endLine.textContent=`Score: ${correct} / ${targetTotal} (${pct}%)`;
 endPBLine.textContent=`Best: ${getPB()} / ${targetTotal}`;

 endTryAgain.textContent=pickTryAgainLine(correct,targetTotal);

 /* â­ UI TWEAK: focus play again automatically */
 setTimeout(()=>{
   document.getElementById("btnPlayAgain").focus();
 },100);
}

btnQuickfire.onclick=()=>startRun("quickfire");
btnHardmode.onclick=()=>startRun("hardmode");
btnQuit.onclick=()=>show("home");
btnRestartRun.onclick=()=>startRun(mode);
btnPlayAgain.onclick=()=>startRun(mode);
btnEndHome.onclick=()=>show("home");

</script>
</body>
</html>

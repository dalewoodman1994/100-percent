<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100 Percent</title>

  <style>
    :root{
      --bg: #0b0d12;
      --text: #f3f6ff;
      --muted: rgba(243, 246, 255, 0.70);
      --border: rgba(243, 246, 255, 0.12);
      --accent: #7c5cff;
      --good: #2ee59d;
      --bad:  #ff4d6d;
      --shadow: 0 18px 50px rgba(0,0,0,.40);
      --radius: 18px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(124,92,255,0.28), transparent 60%),
                  radial-gradient(900px 600px at 80% 0%, rgba(46,229,157,0.14), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{ max-width: 520px; margin: 0 auto; padding: 18px 14px 24px; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .header{
      padding: 18px 16px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(17,21,34,0.65);
      backdrop-filter: blur(8px);
    }

    .brand{ display:flex; align-items: baseline; justify-content: space-between; gap: 10px; }
    .brand h1{ margin: 0; font-size: 26px; letter-spacing: 0.2px; }

    .pill{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 12px;
      user-select: none;
      white-space: nowrap;
    }

    .tagDot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(124,92,255,0.6);
    }

    .subtitle{ margin: 10px 0 0; color: var(--muted); font-size: 14px; line-height: 1.3; }
    .content{ padding: 14px; }

    .btn{
      width: 100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.05s ease, background 0.15s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ background: rgba(255,255,255,0.06); }
    .btn:disabled{ opacity: 0.65; cursor: not-allowed; }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(124,92,255,0.35), rgba(124,92,255,0.12));
      border-color: rgba(124,92,255,0.35);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(255,77,109,0.26), rgba(255,77,109,0.10));
      border-color: rgba(255,77,109,0.35);
    }

    .row{ display:flex; gap: 10px; margin-top: 10px; }
    .row .btn{ flex: 1; }

    .tinyRow{ display:flex; gap: 10px; margin-top: 12px; }

    .linkBtn{
      flex: 1;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      font-size: 13px;
      cursor:pointer;
    }

    .bannerSlot{
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: rgba(243,246,255,0.55);
      font-size: 12px;
      text-align:center;
    }

    .footer{
      margin-top: 12px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      color: rgba(243,246,255,0.55);
      font-size: 12px;
      padding: 0 2px;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* Gameplay */
    .hud{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .hud .big{ font-size: 18px; font-weight: 900; }
    .hud .small{ color: var(--muted); font-size: 12px; margin-top: 2px; }

    .flagWrap{
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    img#flag{ display:block; width:100%; height:auto; }

    .choices{
      margin-top: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .choice{
      text-align:left;
      font-weight: 800;
      letter-spacing: 0.1px;
      position: relative;
      transform: translateZ(0);
    }

    .choice::after{
      content:"";
      position:absolute;
      inset: 0;
      border-radius: 14px;
      pointer-events:none;
      opacity:0;
      transition: opacity 0.18s ease;
    }

    /* Correct / wrong highlight rings */
    .choice.correct::after{
      opacity:1;
      box-shadow: inset 0 0 0 2px rgba(46,229,157,0.55);
    }
    .choice.wrong::after{
      opacity:1;
      box-shadow: inset 0 0 0 2px rgba(255,77,109,0.55);
    }

    .status{ margin-top: 10px; min-height: 22px; font-weight: 900; letter-spacing: 0.2px; }
    .status.good{ color: var(--good); }
    .status.bad{ color: var(--bad); }
    .status.neutral{ color: var(--muted); }

    .note{ margin-top: 10px; color: rgba(243,246,255,0.60); font-size: 12px; line-height: 1.35; }

    /* End screen */
    .resultBig{ font-size: 30px; font-weight: 1000; letter-spacing: 0.3px; margin: 4px 0 2px; }
    .resultSub{ color: var(--muted); font-size: 14px; margin: 0 0 12px; }

    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .stat{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    .stat .k{ color: var(--muted); font-size: 12px; }
    .stat .v{ font-weight: 1000; font-size: 18px; margin-top: 2px; }

    .divider{ height: 1px; background: var(--border); margin: 14px 0; }

    /* Animations */
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
      100% { transform: translateX(0); }
    }
    @keyframes pop {
      0% { transform: scale(1); }
      40% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    @keyframes flashGood {
      0% { box-shadow: 0 0 0 rgba(46,229,157,0); }
      30% { box-shadow: 0 0 0 3px rgba(46,229,157,0.30), 0 0 26px rgba(46,229,157,0.25); }
      100% { box-shadow: 0 0 0 rgba(46,229,157,0); }
    }
    @keyframes flashBad {
      0% { box-shadow: 0 0 0 rgba(255,77,109,0); }
      30% { box-shadow: 0 0 0 3px rgba(255,77,109,0.32), 0 0 26px rgba(255,77,109,0.22); }
      100% { box-shadow: 0 0 0 rgba(255,77,109,0); }
    }
    @keyframes confettiPulse {
      0% { transform: translateY(10px); opacity: 0; }
      20% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-8px); opacity: 0.0; }
    }

    .animShake { animation: shake 420ms ease; }
    .animPop { animation: pop 180ms ease; }
    .flashGood { animation: flashGood 420ms ease; }
    .flashBad { animation: flashBad 520ms ease; }

    .pbToast{
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(124,92,255,0.22);
      border: 1px solid rgba(124,92,255,0.35);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.2px;
      display: none;
      gap: 8px;
      align-items: center;
    }
    .pbToast.show{
      display: inline-flex;
      animation: confettiPulse 900ms ease;
    }
    .pbStar{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(124,92,255,0.65);
    }

    @media (min-width: 540px){ .wrap{ padding-top: 24px; } }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HOME -->
    <section id="home" class="screen active">
      <div class="card">
        <div class="header">
          <div class="brand">
            <h1>100 Percent</h1>
            <div class="pill"><span class="tagDot"></span><span id="homeCategory">Flags</span></div>
          </div>
          <p class="subtitle">One mistake ends your run. Can you get 100%?</p>
        </div>

        <div class="content">
          <button id="btnQuickfire" class="btn btnPrimary">Quickfire (30)</button>

          <div class="row">
            <button id="btnHardmode" class="btn btnDanger">Hardmode (195)</button>
            <button id="btnHow" class="btn">How it works</button>
          </div>

          <div class="tinyRow">
            <button id="btnBadges" class="linkBtn" title="Coming soon">Badges (soon)</button>
            <button id="btnLeaders" class="linkBtn" title="Coming soon">Leaderboards (soon)</button>
          </div>

          <div id="bannerHome" class="bannerSlot">
            Banner Ad Area (safe zone) â€” will go here later
          </div>

          <div class="footer">
            <span>v0.1</span>
            <span>About â€¢ Privacy</span>
          </div>
        </div>
      </div>
    </section>

    <!-- PLAY -->
    <section id="play" class="screen">
      <div class="card" id="playCard">
        <div class="pbToast" id="pbToast"><span class="pbStar"></span><span>NEW PERSONAL BEST</span></div>

        <div class="header">
          <div class="hud">
            <div>
              <div class="big" id="hudMode">Quickfire</div>
              <div class="small" id="hudProgress">0 / 30</div>
              <div class="small" id="hudPB">PB: 0 / 30</div>
            </div>
            <div class="pill"><span class="tagDot"></span><span id="pillCategoryName">Flags</span></div>
          </div>
          <div class="row">
            <button id="btnQuit" class="btn">Home</button>
            <button id="btnRestartRun" class="btn">Restart</button>
          </div>
        </div>

        <div class="content">
          <div class="flagWrap" id="flagWrap">
            <img id="flag" alt="Flag" />
          </div>

          <div class="choices" id="choices"></div>

          <div id="status" class="status neutral"></div>
          <div class="note" id="note"></div>
        </div>
      </div>
    </section>

    <!-- END -->
    <section id="end" class="screen">
      <div class="card">
        <div class="header">
          <div class="brand">
            <h1 id="endTitle">Run ended</h1>
            <div class="pill"><span class="tagDot"></span><span id="endMode">Quickfire</span></div>
          </div>
          <p class="subtitle" id="endSubtitle">Try again. One mistake ends it.</p>
        </div>

        <div class="content">
          <div class="resultBig" id="endPercent">0%</div>
          <div class="resultSub" id="endLine">You got 0 out of 30.</div>

          <div class="statGrid">
            <div class="stat">
              <div class="k">Correct</div>
              <div class="v" id="statCorrect">0</div>
            </div>
            <div class="stat">
              <div class="k">Target</div>
              <div class="v" id="statTarget">30</div>
            </div>
          </div>

          <div class="statGrid" style="margin-top:10px;">
            <div class="stat" style="grid-column: 1 / -1;">
              <div class="k">Personal Best (this mode)</div>
              <div class="v" id="statPB">0 / 30</div>
            </div>
          </div>

          <div class="divider"></div>

          <button id="btnPlayAgain" class="btn btnPrimary">Play again</button>
          <div class="row">
            <button id="btnEndHome" class="btn">Home</button>
            <button id="btnContinueAd" class="btn" disabled title="Coming soon">Continue (watch ad)</button>
          </div>

          <div id="bannerEnd" class="bannerSlot">
            Banner Ad Area (safe zone) â€” will go here later
          </div>

          <div class="footer">
            <span>Flags</span>
            <span>Share your %</span>
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
  // State
  let category = "flags";
  let mode = "quickfire";
  let targetTotal = 30;
  let questions = [];
  let idx = 0;
  let correct = 0;
  let locked = false;

  const screens = {
    home: document.getElementById("home"),
    play: document.getElementById("play"),
    end:  document.getElementById("end"),
  };

  const playCard = document.getElementById("playCard");
  const flagWrap = document.getElementById("flagWrap");
  const flagImg = document.getElementById("flag");
  const choicesDiv = document.getElementById("choices");
  const statusEl = document.getElementById("status");
  const noteEl = document.getElementById("note");
  const hudMode = document.getElementById("hudMode");
  const hudProgress = document.getElementById("hudProgress");
  const hudPB = document.getElementById("hudPB");
  const pbToast = document.getElementById("pbToast");
  const pillCategoryName = document.getElementById("pillCategoryName");

  const endTitle = document.getElementById("endTitle");
  const endMode = document.getElementById("endMode");
  const endPercent = document.getElementById("endPercent");
  const endLine = document.getElementById("endLine");
  const statCorrect = document.getElementById("statCorrect");
  const statTarget = document.getElementById("statTarget");
  const statPB = document.getElementById("statPB");

  function show(screenName){
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[screenName].classList.add("active");
  }

  function setStatus(text, kind){
    statusEl.textContent = text || "";
    statusEl.classList.remove("good","bad","neutral");
    statusEl.classList.add(kind || "neutral");
  }

  function setButtonsDisabled(disabled){
    document.querySelectorAll("button.choice").forEach(b => b.disabled = disabled);
  }

  function calcFinalPercent(){
    const pct = Math.round((correct / targetTotal) * 100);
    return Math.max(0, Math.min(100, pct));
  }

  function renderHud(){
    hudMode.textContent = (mode === "hardmode") ? "Hardmode" : "Quickfire";
    hudProgress.textContent = `${correct} / ${targetTotal}`;
    hudPB.textContent = `PB: ${getPersonalBest()} / ${targetTotal}`;
  }

  function placeholderFlag(){
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="800" height="480">
        <rect width="100%" height="100%" fill="#0f1320"/>
        <rect x="12" y="12" width="776" height="456" fill="none" stroke="rgba(243,246,255,0.22)" stroke-width="6"/>
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
          font-family="Arial" font-size="28" fill="rgba(243,246,255,0.75)">
          Image failed to load
        </text>
      </svg>
    `);
  }

  function animateOnce(el, className){
    el.classList.remove(className);
    void el.offsetWidth;
    el.classList.add(className);
    setTimeout(() => el.classList.remove(className), 700);
  }

  function pbKey(){ return `pb_${category}_${mode}`; }
  function getPersonalBest(){
    const v = Number(localStorage.getItem(pbKey()));
    return Number.isFinite(v) ? v : 0;
  }
  function setPersonalBest(newBest){ localStorage.setItem(pbKey(), String(newBest)); }
  function showPBToast(){
    pbToast.classList.remove("show");
    void pbToast.offsetWidth;
    pbToast.classList.add("show");
    setTimeout(() => pbToast.classList.remove("show"), 900);
  }
  function maybeUpdatePB(){
    const currentPB = getPersonalBest();
    if (correct > currentPB){
      setPersonalBest(correct);
      renderHud();
      showPBToast();
      return true;
    }
    return false;
  }

  async function startRun(newMode){
    mode = newMode;
    correct = 0;
    idx = 0;
    locked = false;

    pillCategoryName.textContent = "Flags";

    show("play");
    setStatus("Loading...", "neutral");
    noteEl.textContent = "";

    const res = await fetch(`/api/questionset?mode=${mode}&category=${category}`, { cache: "no-store" });
    const payload = await res.json();

    if (payload.error){
      setStatus("Error: " + payload.error, "bad");
      return;
    }

    targetTotal = payload.totalPlanned;
    questions = payload.questions || [];

    renderHud();
    showQuestion();
  }

  function showQuestion(){
    renderHud();
    setStatus("", "neutral");
    locked = false;
    setButtonsDisabled(false);

    if (idx >= questions.length){
      return endRun(correct >= targetTotal ? "ðŸŽ‰ PERFECT RUN" : "Run ended");
    }

    const q = questions[idx];

    flagImg.onerror = () => { flagImg.onerror = null; flagImg.src = placeholderFlag(); };
    flagImg.src = q.image_url;

    choicesDiv.innerHTML = "";
    q.choices.forEach((choiceText, choiceIndex) => {
      const btn = document.createElement("button");
      btn.className = "btn choice";
      btn.textContent = choiceText;
      btn.onclick = () => answer(choiceIndex, btn);
      choicesDiv.appendChild(btn);
    });
  }

  function highlightCorrectAnswer(correctIndex, clickedBtn){
    const btns = Array.from(document.querySelectorAll("button.choice"));

    // Mark clicked as wrong if it wasn't already correct
    if (clickedBtn) clickedBtn.classList.add("wrong");

    // Always highlight the correct one
    const correctBtn = btns[correctIndex];
    if (correctBtn) correctBtn.classList.add("correct");
  }

  function answer(selectedIndex, clickedBtn){
    if (locked) return;
    locked = true;
    setButtonsDisabled(true);

    const q = questions[idx];

    if (selectedIndex === q.correct_index){
      clickedBtn.classList.add("correct");
      setStatus("âœ… Correct", "good");

      animateOnce(clickedBtn, "animPop");
      animateOnce(flagWrap, "flashGood");

      correct++;
      const pbUpdated = maybeUpdatePB();
      if (pbUpdated) animateOnce(playCard, "flashGood");

      renderHud();

      setTimeout(() => {
        idx++;
        showQuestion();
      }, 420);

    } else {
      setStatus("âŒ Wrong", "bad");
      animateOnce(playCard, "animShake");
      animateOnce(flagWrap, "flashBad");

      // âœ… NEW: Show correct answer on Quickfire only
      if (mode === "quickfire") {
        highlightCorrectAnswer(q.correct_index, clickedBtn);
      } else {
        // Hardmode: keep it brutal, only mark their click wrong
        clickedBtn.classList.add("wrong");
      }

      setTimeout(() => {
        endRun("âŒ Run failed");
      }, 900);
    }
  }

  function endRun(title){
    maybeUpdatePB();

    const pct = calcFinalPercent();
    show("end");

    endTitle.textContent = title;
    endMode.textContent = (mode === "hardmode") ? "Hardmode" : "Quickfire";
    endPercent.textContent = `${pct}%`;
    endLine.textContent = `You got ${correct} out of ${targetTotal}.`;

    statCorrect.textContent = String(correct);
    statTarget.textContent = String(targetTotal);
    statPB.textContent = `${getPersonalBest()} / ${targetTotal}`;
  }

  document.getElementById("btnQuickfire").onclick = () => startRun("quickfire");
  document.getElementById("btnHardmode").onclick = () => startRun("hardmode");
  document.getElementById("btnHow").onclick = () => alert("Pick a mode. Answer every question correctly. One wrong answer ends the run.");
  document.getElementById("btnBadges").onclick = () => alert("Badges are coming soon. You'll earn them for perfect runs.");
  document.getElementById("btnLeaders").onclick = () => alert("Leaderboards are coming soon.");

  document.getElementById("btnQuit").onclick = () => show("home");
  document.getElementById("btnRestartRun").onclick = () => startRun(mode);

  document.getElementById("btnPlayAgain").onclick = () => startRun(mode);
  document.getElementById("btnEndHome").onclick = () => show("home");
  document.getElementById("btnContinueAd").onclick = () => alert("Rewarded ads coming soon.");
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>100 Percent</title>

<style>
:root{
  --bg:#0b0d12;
  --text:#f3f6ff;
  --muted:rgba(243,246,255,.72);
  --border:rgba(243,246,255,.12);
  --accent:#7c5cff;
  --good:#2ee59d;
  --bad:#ff4d6d;
}

body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(900px 500px at 20% -10%, rgba(124,92,255,.22), transparent 60%),
             radial-gradient(800px 500px at 80% 0%, rgba(46,229,157,.12), transparent 55%),
             var(--bg);
  color:var(--text);
}

.wrap{
  max-width:560px;
  margin:auto;
  padding:14px;
}

/* screens */
.screen{ display:none; }
.screen.active{ display:block; }

/* Home ONLY: fills viewport & centers card, without affecting play/end */
#home.active{
  min-height:100vh;
  display:flex;
  align-items:center;
}

.card{
  width:100%;
  border:1px solid var(--border);
  border-radius:18px;
  background:rgba(255,255,255,.035);
  overflow:hidden;
}
.header{padding:20px;border-bottom:1px solid var(--border);}
.content{padding:18px;}

.brandRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brandLeft{
  display:flex;
  align-items:center;
  gap:14px;
}
.brandTitle{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.brandTitle h1{margin:0;font-size:28px;letter-spacing:.2px;}
.brandTitle p{margin:0;color:var(--muted);font-size:14px;}

.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:9px 12px;border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  color:var(--muted);
  font-size:12px;
  user-select:none;
}
.dot{
  width:9px;height:9px;border-radius:999px;
  background:var(--accent);
  box-shadow:0 0 18px rgba(124,92,255,.55);
}

.btn{
  width:100%;
  padding:15px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  color:white;
  font-weight:900;
  cursor:pointer;
}
.btnPrimary{background:rgba(124,92,255,.45);}

.bigPlay{
  padding:20px!important;
  font-size:22px!important;
  font-weight:1000;
}
.bigQuickfire{
  padding:24px!important;
  font-size:24px!important;
  font-weight:1000!important;
  letter-spacing:.2px;
  border-color: rgba(124,92,255,.35);
  box-shadow: 0 14px 30px rgba(124,92,255,.20);
}

.row{display:flex;gap:12px;margin-top:12px;}
.row .btn{flex:1;}

.flagWrap{
  border-radius:16px;
  overflow:hidden;
  border:1px solid var(--border);
  background:rgba(0,0,0,.18);
}
#flag{width:100%;display:block;}

.hudRow{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  align-items:flex-end;
}
.hudBlock{display:flex;flex-direction:column;gap:4px;}
.hudMain{font-weight:1000;font-size:16px;}
.hudSub{color:var(--muted);font-size:12px;}

.choices{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
.choice.correct{outline:2px solid var(--good);}
.choice.wrong{outline:2px solid var(--bad);}

.status{margin-top:10px;font-weight:900;letter-spacing:.2px;}
.status.good{color:var(--good);}
.status.bad{color:var(--bad);}
.status.neutral{color:var(--muted);}

.resultBig{
  font-size:44px;
  font-weight:1000;
  text-align:center;
}
.resultSub{
  text-align:center;
  color:var(--muted);
  margin-top:7px;
  font-size:15px;
}
.note{
  text-align:center;
  color:var(--muted);
  margin-top:12px;
  font-size:14px;
}
.divider{height:1px;background:var(--border);margin:16px 0;}

.miniBtn{
  font-weight:900;
  font-size:14px;
  padding:12px;
  border-radius:16px;
  border:1px dashed var(--border);
  background:rgba(255,255,255,.03);
  color:var(--muted);
}

/* Celebration */
.perfectGlow{
  animation: glow 900ms ease-in-out infinite alternate;
}
@keyframes glow{
  from{ text-shadow: 0 0 0 rgba(46,229,157,0); }
  to{ text-shadow: 0 0 18px rgba(46,229,157,.35); }
}

.confetti{position:relative;height:0;}
.confetti i{
  position:absolute;
  top:-6px;
  width:8px;height:14px;border-radius:4px;
  opacity:0;
  animation: pop 900ms ease forwards;
}
@keyframes pop{
  0%{ transform:translateY(0) rotate(0deg); opacity:0; }
  15%{ opacity:1; }
  100%{ transform:translateY(120px) rotate(240deg); opacity:0; }
}

/* Logo sizing */
.logo{
  width:76px;
  height:76px;
  flex:0 0 auto;
  filter: drop-shadow(0 14px 22px rgba(0,0,0,.35));
}
.footerThanks{
  margin-top:14px;
  text-align:center;
  color:rgba(243,246,255,.55);
  font-size:12px;
}

@media (max-width: 420px){
  .brandTitle h1{ font-size:26px; }
  .logo{ width:70px; height:70px; }
  .bigQuickfire{ font-size:22px!important; }
}
</style>
</head>

<body>
<div class="wrap">

<!-- HOME -->
<section id="home" class="screen active">
  <div class="card">
    <div class="header">
      <div class="brandRow">
        <div class="brandLeft">

          <!-- LOGO: 100% in globe with flames -->
          <svg class="logo" viewBox="0 0 96 96" aria-hidden="true">
            <defs>
              <linearGradient id="gradText" x1="0" x2="1">
                <stop offset="0" stop-color="#7c5cff" stop-opacity="0.98"/>
                <stop offset="1" stop-color="#2ee59d" stop-opacity="0.92"/>
              </linearGradient>
              <linearGradient id="gradFlame" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#ffcc66" stop-opacity="0.95"/>
                <stop offset="0.55" stop-color="#ff6b6b" stop-opacity="0.92"/>
                <stop offset="1" stop-color="#7c5cff" stop-opacity="0.70"/>
              </linearGradient>
              <radialGradient id="glow" cx="50%" cy="45%" r="60%">
                <stop offset="0" stop-color="rgba(124,92,255,0.55)"/>
                <stop offset="1" stop-color="rgba(124,92,255,0.0)"/>
              </radialGradient>
            </defs>

            <circle cx="48" cy="48" r="42" fill="url(#glow)"/>

            <g fill="url(#gradFlame)" opacity="0.95">
              <path d="M48 3c3 6 2 10-1 14c-3-4-4-8 1-14z"/>
              <path d="M33 6c2 6 0 10-4 13c-2-4-2-8 4-13z"/>
              <path d="M63 6c6 5 6 9 4 13c-4-3-6-7-4-13z"/>
              <path d="M18 14c1 6-2 10-7 12c-1-5 1-9 7-12z"/>
              <path d="M78 14c6 3 8 7 7 12c-5-2-8-6-7-12z"/>
              <path d="M6 38c6 2 9 6 9 11c-5-1-9-5-9-11z"/>
              <path d="M90 38c0 6-4 10-9 11c0-5 3-9 9-11z"/>
              <path d="M24 84c5-1 9 1 11 6c-6 1-10-1-11-6z"/>
              <path d="M72 84c-1 5-5 7-11 6c2-5 6-7 11-6z"/>
            </g>

            <circle cx="48" cy="48" r="30" fill="rgba(255,255,255,0.04)" stroke="rgba(243,246,255,0.20)" stroke-width="2"/>
            <g fill="none" stroke="rgba(243,246,255,0.18)" stroke-width="2">
              <path d="M18 48c10-12 50-12 60 0"/>
              <path d="M18 48c10 12 50 12 60 0"/>
              <path d="M48 18c10 12 10 48 0 60"/>
              <path d="M48 18c-10 12-10 48 0 60"/>
              <path d="M22 36c9 6 43 6 52 0"/>
              <path d="M22 60c9-6 43-6 52 0"/>
            </g>

            <text x="48" y="54" text-anchor="middle"
                  font-size="20" font-weight="1000"
                  fill="url(#gradText)" style="letter-spacing:0.5px;">100%</text>
          </svg>

          <div class="brandTitle">
            <h1>100 Percent</h1>
            <p>One mistake ends your run.</p>
          </div>
        </div>

        <div class="pill"><span class="dot"></span><span>Flags</span></div>
      </div>
    </div>

    <div class="content">
      <button id="btnQuickfire" class="btn btnPrimary bigQuickfire">‚ö° Quickfire (30)</button>
      <div class="row">
        <button id="btnHardmode" class="btn">Hardmode (195)</button>
      </div>
      <div class="note">
        Tip: Hit <b>30/30</b> to join the <b>100% club</b> üëë
      </div>
      <div class="footerThanks">Thanks for playing ‚ù§Ô∏è</div>
    </div>
  </div>
</section>

<!-- PLAY -->
<section id="play" class="screen">
  <div class="card">
    <div class="header">
      <div class="hudRow">
        <div class="hudBlock">
          <div id="hudMode" class="hudMain">Quickfire</div>
          <div id="hudProgress" class="hudSub">0 / 30</div>
          <div id="hudPB" class="hudSub">PB: 0 / 30</div>
          <div id="hudBestTime" class="hudSub">Best Time (30/30): ‚Äî</div>
        </div>
        <div class="hudBlock" style="text-align:right;">
          <div class="hudMain">Time</div>
          <div id="hudTime" class="hudSub">0:00.0</div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="flagWrap"><img id="flag" alt="flag"></div>
      <div class="choices" id="choices"></div>
      <div id="status" class="status neutral"></div>
      <div id="note" class="note"></div>

      <div class="row">
        <button id="btnQuit" class="btn">Home</button>
        <button id="btnRestartRun" class="btn">Restart</button>
      </div>
    </div>
  </div>
</section>

<!-- END -->
<section id="end" class="screen">
  <div class="card">
    <div class="header">
      <h2 id="endTitle">Run failed</h2>
    </div>

    <div class="content">
      <div id="confetti" class="confetti" aria-hidden="true"></div>

      <div class="resultBig" id="endPercent">0%</div>
      <div class="resultSub" id="endLine">Score: 0 / 30 (0%)</div>
      <div class="resultSub" id="endPBLine">Best: 0 / 30</div>
      <div class="resultSub" id="endTimeLine">Time: 0:00.0</div>
      <div class="resultSub" id="endBestTimeLine">Best Time (30/30): ‚Äî</div>

      <div class="note" id="endTryAgain"></div>
      <div class="note" style="margin-top:8px;color:rgba(243,246,255,.55);">Thanks for playing ‚ù§Ô∏è</div>

      <div class="divider"></div>

      <button id="btnPlayAgain" class="btn btnPrimary bigPlay">PLAY AGAIN</button>

      <div class="row">
        <button id="btnShare" class="btn miniBtn">Share / Copy</button>
        <button id="btnEndHome" class="btn">Home</button>
      </div>
    </div>
  </div>
</section>

</div>

<script>
/* ---------------- STATE ---------------- */
let mode="quickfire";
let category="flags";
let targetTotal=30;
let questions=[];
let idx=0;
let correct=0;
let locked=false;
let streak=0;

/* timer */
let runStartMs=0;
let runEndMs=0;
let timerHandle=null;

/* ---------------- ELEMENTS ---------------- */
const screens={
  home:document.getElementById("home"),
  play:document.getElementById("play"),
  end:document.getElementById("end"),
};

const flag=document.getElementById("flag");
const choicesDiv=document.getElementById("choices");
const statusEl=document.getElementById("status");
const noteEl=document.getElementById("note");

const hudMode=document.getElementById("hudMode");
const hudProgress=document.getElementById("hudProgress");
const hudPB=document.getElementById("hudPB");
const hudTime=document.getElementById("hudTime");
const hudBestTime=document.getElementById("hudBestTime");

const endTitle=document.getElementById("endTitle");
const endPercent=document.getElementById("endPercent");
const endLine=document.getElementById("endLine");
const endPBLine=document.getElementById("endPBLine");
const endTimeLine=document.getElementById("endTimeLine");
const endBestTimeLine=document.getElementById("endBestTimeLine");
const endTryAgain=document.getElementById("endTryAgain");
const confettiEl=document.getElementById("confetti");

/* buttons */
const btnQuickfire=document.getElementById("btnQuickfire");
const btnHardmode=document.getElementById("btnHardmode");
const btnQuit=document.getElementById("btnQuit");
const btnRestartRun=document.getElementById("btnRestartRun");
const btnPlayAgain=document.getElementById("btnPlayAgain");
const btnEndHome=document.getElementById("btnEndHome");
const btnShare=document.getElementById("btnShare");

/* ---------------- HELPERS ---------------- */
function show(screenName){
  Object.values(screens).forEach(x=>x.classList.remove("active"));
  screens[screenName].classList.add("active");
  window.scrollTo(0,0); // ensures no weird scroll position ever
}

function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function pbKey(){ return `pb_${category}_${mode}`; }
function getPB(){ return Number(localStorage.getItem(pbKey())) || 0; }
function setPB(v){ localStorage.setItem(pbKey(), String(v)); }

/* Best time ONLY for perfect runs */
function bestTimeKey(){ return `bestTimePerfect_${category}_${mode}`; }
function getBestTimeMs(){
  const v=Number(localStorage.getItem(bestTimeKey()));
  return Number.isFinite(v) && v>0 ? v : null;
}
function setBestTimeMs(ms){
  localStorage.setItem(bestTimeKey(), String(ms));
}

function formatMs(ms){
  ms=Math.max(0,ms);
  const totalSeconds=ms/1000;
  const minutes=Math.floor(totalSeconds/60);
  const seconds=totalSeconds-minutes*60;
  const secInt=Math.floor(seconds);
  const tenths=Math.floor((seconds-secInt)*10);
  return `${minutes}:${String(secInt).padStart(2,"0")}.${tenths}`;
}

function renderHud(){
  hudMode.textContent = (mode==="hardmode") ? "Hardmode" : "Quickfire";
  hudProgress.textContent = `${correct} / ${targetTotal}`;
  hudPB.textContent = `PB: ${getPB()} / ${targetTotal}`;
  const bt=getBestTimeMs();
  hudBestTime.textContent = `Best Time (30/30): ${bt ? formatMs(bt) : "‚Äî"}`;
}

function startTimer(){
  stopTimer();
  runStartMs=Date.now();
  runEndMs=0;
  hudTime.textContent="0:00.0";
  timerHandle=setInterval(()=>{
    hudTime.textContent=formatMs(Date.now()-runStartMs);
  },100);
}

function stopTimer(){
  if(timerHandle) clearInterval(timerHandle);
  timerHandle=null;
}

function finalizeTimer(){
  runEndMs=Date.now();
  stopTimer();
  return runEndMs-runStartMs;
}

/* Near-miss messages */
function pickTryAgainLine(score,total){
  const pct=Math.round((score/total)*100);
  if(score>=total-1) return "ONE away from 100% üò± run it back!";
  if(pct>=80) return "You were SO close‚Ä¶ next run is it üî•";
  if(pct>=60) return "You're getting sharp üëÄ go again!";
  if(pct>=40) return "Nice progress ‚Äî keep pushing üí™";
  return "Warm-up round üòÑ try again!";
}

/* Confetti */
function burstConfetti(){
  confettiEl.innerHTML="";
  const pieces=18;
  for(let i=0;i<pieces;i++){
    const p=document.createElement("i");
    p.style.left=(Math.random()*100)+"%";
    p.style.top=(-8-Math.random()*18)+"px";
    p.style.animationDelay=(Math.random()*120)+"ms";
    p.style.animationDuration=(700+Math.random()*500)+"ms";
    p.style.transform=`rotate(${Math.floor(Math.random()*280)}deg)`;
    p.style.background=(Math.random()<0.5) ? "rgba(124,92,255,.95)" : "rgba(46,229,157,.90)";
    confettiEl.appendChild(p);
  }
}

/* ---------------- GAME FLOW ---------------- */
async function startRun(newMode){
  mode=newMode;
  correct=0;
  idx=0;
  streak=0;
  locked=false;

  show("play");
  renderHud();

  noteEl.textContent="";
  statusEl.textContent="Loading...";
  statusEl.className="status neutral";

  startTimer();

  const res=await fetch(`/api/questionset?mode=${mode}&category=${category}`,{cache:"no-store"});
  const data=await res.json();

  if(data.error){
    stopTimer();
    statusEl.className="status bad";
    statusEl.textContent="Error: "+data.error;
    return;
  }

  questions=data.questions||[];
  targetTotal=data.totalPlanned||30;

  renderHud();
  showQuestion();
}

function showQuestion(){
  statusEl.textContent="";
  statusEl.className="status neutral";
  noteEl.textContent="";
  locked=false;
  renderHud();

  const q=questions[idx];
  if(!q) return endRun("Run ended");

  flag.src=q.image_url;

  choicesDiv.innerHTML="";
  q.choices.forEach((txt,i)=>{
    const b=document.createElement("button");
    b.className="btn choice";
    b.textContent=txt;
    b.onclick=()=>answer(i,b);
    choicesDiv.appendChild(b);
  });
}

function answer(i,btn){
  if(locked) return;
  locked=true;

  const q=questions[idx];
  const allBtns=[...document.querySelectorAll(".choice")];
  allBtns.forEach(b=>b.disabled=true);

  if(i===q.correct_index){
    btn.classList.add("correct");
    correct++;
    streak++;

    if(correct>getPB()) setPB(correct);

    statusEl.className="status good";
    statusEl.textContent=(streak>=3) ? `üî• ${streak} streak` : "‚úÖ Correct";

    renderHud();

    setTimeout(()=>{
      idx++;
      if(idx>=questions.length) return endRun("üéâ PERFECT RUN");
      showQuestion();
    },380);
  }else{
    streak=0;

    statusEl.className="status bad";
    statusEl.textContent="‚ùå Wrong";
    btn.classList.add("wrong");

    if(mode==="quickfire"){
      const correctBtn=allBtns[q.correct_index];
      if(correctBtn) correctBtn.classList.add("correct");
      noteEl.textContent=`Correct answer: ${q.choices[q.correct_index]}`;
    }

    setTimeout(()=>endRun("‚ùå Run failed"),850);
  }
}

function endRun(title){
  const elapsedMs=finalizeTimer();
  const pct=clamp(Math.round((correct/targetTotal)*100),0,100);
  const perfect=(correct===targetTotal);

  // Save best time ONLY when perfect, and only if faster
  if(perfect){
    const currentBest=getBestTimeMs();
    if(!currentBest || elapsedMs<currentBest){
      setBestTimeMs(elapsedMs);
    }
  }

  renderHud();
  show("end");

  if(perfect){
    endTitle.textContent="üèÜ 100% PERFECT!";
    endPercent.classList.add("perfectGlow");
    burstConfetti();
    endTryAgain.textContent="That‚Äôs elite. Screenshot it üòÑ";
  }else{
    endTitle.textContent=title;
    endPercent.classList.remove("perfectGlow");
    confettiEl.innerHTML="";
    endTryAgain.textContent=pickTryAgainLine(correct,targetTotal);
  }

  endPercent.textContent=`${pct}%`;
  endLine.textContent=`Score: ${correct} / ${targetTotal} (${pct}%)`;
  endPBLine.textContent=`Best: ${getPB()} / ${targetTotal}`;
  endTimeLine.textContent=`Time: ${formatMs(elapsedMs)}`;
  const bt=getBestTimeMs();
  endBestTimeLine.textContent=`Best Time (30/30): ${bt ? formatMs(bt) : "‚Äî"}`;

  setTimeout(()=>btnPlayAgain.focus(),80);
}

/* ---------------- SHARE ---------------- */
function buildShareText(){
  const pct=clamp(Math.round((correct/targetTotal)*100),0,100);
  const url=window.location.origin;
  const modeLabel=(mode==="hardmode") ? "Hardmode" : "Quickfire";
  return `I scored ${pct}% on 100 Percent (Flags ${modeLabel}). Can you beat me? ${url}`;
}

async function shareScore(){
  const text=buildShareText();

  if(navigator.share){
    try{
      await navigator.share({title:"100 Percent", text});
      btnShare.textContent="Shared ‚úÖ";
      setTimeout(()=>btnShare.textContent="Share / Copy",1200);
      return;
    }catch(e){}
  }

  try{
    await navigator.clipboard.writeText(text);
    btnShare.textContent="Copied ‚úÖ";
    setTimeout(()=>btnShare.textContent="Share / Copy",1200);
  }catch(e){
    window.prompt("Copy this:", text);
  }
}

/* ---------------- BUTTONS ---------------- */
btnQuickfire.onclick=()=>startRun("quickfire");
btnHardmode.onclick=()=>startRun("hardmode");
btnQuit.onclick=()=>{ stopTimer(); show("home"); };
btnRestartRun.onclick=()=>startRun(mode);
btnPlayAgain.onclick=()=>startRun(mode);
btnEndHome.onclick=()=>show("home");
btnShare.onclick=()=>shareScore();
</script>
</body>
</html>
